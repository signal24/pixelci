default:
  interruptible: true

stages:
  - test
  - build
  - deploy
  - post-deploy
  - mirror

.test-base:
  stage: test
  rules:
    - if: $CI_COMMIT_TAG
      when: never
    - if: $CI_COMMIT_TITLE =~ /^v\d+\.\d+\.\d+$/
      when: never
    - if: $CI_COMMIT_MESSAGE =~ /\[skip test\]/
      when: never
    - when: always
  before_script:
    - corepack enable
    - yarn --immutable

.test-services:
  extends: .test-base
  image: mcr.microsoft.com/playwright:v1.58.2-jammy
  services:
    - name: mysql:8
      variables:
        MYSQL_ROOT_PASSWORD: secret
        MYSQL_DATABASE: pixelci
    - name: redis:alpine
    - name: chrislusf/seaweedfs:latest
      alias: seaweedfs
      entrypoint: ['sh', '-c']
      command:
        - |
          echo '{"identities":[{"name":"test","credentials":[{"accessKey":"test","secretKey":"test"}],"actions":["Admin"]}]}' > /tmp/s3.json
          exec weed server -s3 -s3.config=/tmp/s3.json
  variables:
    S3_ENDPOINT: http://seaweedfs:8333
    S3_ACCESS_KEY_ID: test
    S3_ACCESS_SECRET: test
    S3_BUCKET: pixelci
    MYSQL_HOST: mysql
    MYSQL_PORT: 3306
    REDIS_HOST: redis
    REDIS_PORT: 6379

test:api:
  extends: .test-services
  script: yarn test:api

test:e2e:
  extends: .test-services
  tags:
    - highmem
  script: yarn test:e2e
  artifacts:
    when: always
    paths:
      - packages/ui/screenshots
      - packages/ui/playwright-report
      - packages/ui/test-results
    expire_in: 1 week

test:cli:
  extends: .test-base
  image: node:22
  script: yarn test:cli

test:ui:types:
  extends: .test-base
  image: node:22
  script:
    - yarn workspace @zyno-io/pixelci-ui exec npx generate-openapi-client
    - yarn test:ui:types

visual regression test:
  needs:
    - test:e2e
  rules:
    - if: $CI_COMMIT_TAG
      when: never
    - if: $CI_COMMIT_TITLE =~ /^v\d+\.\d+\.\d+$/
      when: never
    - if: $CI_COMMIT_MESSAGE =~ /\[skip vrt\]/
      when: never
    - if: $CI_COMMIT_MESSAGE =~ /\[skip test\]/
      when: never
    - if: $CI_COMMIT_MESSAGE =~ /\[defer vrt\]/
      when: never
    - when: on_success
  stage: test
  image: ${CI_REGISTRY_IMAGE}/cli:canary
  variables:
    PIXELCI_IMAGES_PATH: packages/ui/screenshots
  script: pixelci

visual regression test (deferred):
  needs:
    - test:e2e
    - deploy
  rules:
    - if: $CI_COMMIT_TAG
      when: never
    - if: $CI_COMMIT_TITLE =~ /^v\d+\.\d+\.\d+$/
      when: never
    - if: $CI_COMMIT_MESSAGE =~ /\[skip vrt\]/
      when: never
    - if: $CI_COMMIT_MESSAGE =~ /\[skip test\]/
      when: never
    - if: $CI_COMMIT_MESSAGE =~ /\[defer vrt\]/
  stage: post-deploy
  image: ${CI_REGISTRY_IMAGE}/cli:canary
  variables:
    PIXELCI_IMAGES_PATH: packages/ui/screenshots
  script: pixelci

.build-base:
  stage: build
  dependencies: []
  image: quay.io/containers/buildah
  before_script:
    - |
      export BUILDAH_ISOLATION=chroot
      export STORAGE_DRIVER=vfs

      buildah login \
        --username=${CI_REGISTRY_USER} \
        --password=${CI_REGISTRY_PASSWORD} \
        ${CI_REGISTRY}

build:canary:
  extends: .build-base
  rules:
    - if: $CI_COMMIT_TITLE =~ /^v\d+\.\d+\.\d+$/
      when: never
    - if: $CI_COMMIT_BRANCH == "main"
  script: |
    buildah bud \
      -t ${CI_REGISTRY_IMAGE}:canary \
      .
    buildah push ${CI_REGISTRY_IMAGE}:canary

build:canary:cli:
  extends: .build-base
  rules:
    - if: $CI_COMMIT_TITLE =~ /^v\d+\.\d+\.\d+$/
      when: never
    - if: $CI_COMMIT_BRANCH == "main"
  script: |
    buildah bud \
      -f Dockerfile.cli \
      -t ${CI_REGISTRY_IMAGE}/cli:canary \
      .
    buildah push ${CI_REGISTRY_IMAGE}/cli:canary

deploy:
  stage: deploy
  needs:
    - build:canary
    - build:canary:cli
  rules:
    - if: $CI_COMMIT_TITLE =~ /^v\d+\.\d+\.\d+$/
      when: never
    - if: $CI_COMMIT_BRANCH == "main"
  tags:
    - clusterwide
    - s24-ova-devops-k3s-0
  image:
    name: bitnami/kubectl:latest
  script: |
    kubectl -n pixelci rollout restart deployment pixelci
    kubectl -n pixelci rollout status deployment pixelci
    kubectl -n pixelci exec deployment/pixelci -- node . migration:run
    kubectl -n pixelci rollout restart deployment pixelci-worker

mirror:
  stage: mirror
  rules:
    - if: $CI_COMMIT_MESSAGE =~ /\[skip mirror\]/
      when: never
    - if: $CI_COMMIT_BRANCH == "main"
    - if: $CI_COMMIT_TAG =~ /^v/
  image:
    name: alpine/git
    entrypoint: ['']
  script: |
    export GIT_SSH_COMMAND="ssh -o StrictHostKeyChecking=no"
    mkdir ~/.ssh
    echo $GITHUB_SSH_KEY_B64 | base64 -d > ~/.ssh/id_ed25519
    chmod 600 ~/.ssh/id_ed25519
    git remote add github git@github.com:zyno-io/pixelci.git
    if [ -n "$CI_COMMIT_TAG" ]; then
      git push github "$CI_COMMIT_TAG"
    else
      git push -u github HEAD:refs/heads/main --force
    fi
